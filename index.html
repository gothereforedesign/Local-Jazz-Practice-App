<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jazz Practice Randomizer</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { overscroll-behavior-y: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
        .notion-shadow { shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
    </style>
</head>
<body class="bg-[#ffffff]">
    <div id="root"></div>

    <script type="text/babel" data-presets="react,env">
        const { useState, useEffect } = React;

        // --- Icons ---
        const Icon = ({ path, size = 18, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{ __html: path }} />
        );
        
        const Icons = {
            Shuffle: (p) => <Icon {...p} path='<path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l14.2-12.7c.9-1.1 2.1-1.7 3.5-1.7H22"/><path d="M2 5h1.4c1.3 0 2.5.6 3.3 1.7l14.2 12.7c.9 1.1 2.1 1.7 3.5 1.7H22"/>' />,
            Settings: (p) => <Icon {...p} path='<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>' />,
            Eye: (p) => <Icon {...p} path='<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>' />,
            EyeOff: (p) => <Icon {...p} path='<path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7c.44 0 .87-.03 1.28-.09"/><line x1="2" y1="2" x2="22" y2="22"/>' />,
            Maximize: (p) => <Icon {...p} path='<path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/>' />,
            Minimize: (p) => <Icon {...p} path='<path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/>' />,
            Lock: (p) => <Icon {...p} path='<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>' />,
            Unlock: (p) => <Icon {...p} path='<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/>' />,
            Plus: (p) => <Icon {...p} path='<line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>' />,
            Trash2: (p) => <Icon {...p} path='<path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>' />,
            Save: (p) => <Icon {...p} path='<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>' />,
            Bookmark: (p) => <Icon {...p} path='<path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/>' />,
            HelpCircle: (p) => <Icon {...p} path='<circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>' />
        };

        // --- Earth & Jewel Tone Colors ---
        const THEME_COLORS = {
            graphite: { bg: 'bg-[#fafafa]', primary: 'bg-[#37352f]', hover: 'hover:bg-[#201f1c]', name: 'Graphite', text: 'text-white' },
            rust: { bg: 'bg-[#fdf5f2]', primary: 'bg-[#b35944]', hover: 'hover:bg-[#964a39]', name: 'Rust', text: 'text-white' },
            ochre: { bg: 'bg-[#fcf7f0]', primary: 'bg-[#c4914d]', hover: 'hover:bg-[#a67b41]', name: 'Ochre', text: 'text-white' },
            sage: { bg: 'bg-[#f3f6f3]', primary: 'bg-[#6a7d6a]', hover: 'hover:bg-[#586858]', name: 'Sage', text: 'text-white' },
            teal: { bg: 'bg-[#f0f6f6]', primary: 'bg-[#4b7d7d]', hover: 'hover:bg-[#3d6666]', name: 'Teal', text: 'text-white' },
            slate: { bg: 'bg-[#f1f5f9]', primary: 'bg-[#475569]', hover: 'hover:bg-[#334155]', name: 'Slate', text: 'text-white' },
            eggplant: { bg: 'bg-[#f7f3f8]', primary: 'bg-[#6d517c]', hover: 'hover:bg-[#5a4366]', name: 'Eggplant', text: 'text-white' },
            clay: { bg: 'bg-[#f9f5f3]', primary: 'bg-[#9d6b53]', hover: 'hover:bg-[#835945]', name: 'Clay', text: 'text-white' }
        };

        const TEXT_SIZES = { small: { normal: 'text-2xl', fullscreen: 'text-4xl' } };

        const PracticeSection = ({ sectionKey, section, isFullScreen, editMode, onToggleVisibility, onToggleLock, onEdit, onDelete, textSize, isFlashing, isWide, onDragStart, onDragOver, onDragEnd, isDragging, isDragOver }) => {
            return (
                <div 
                draggable={editMode}
                onDragStart={(e) => editMode && onDragStart(e, sectionKey)}
                onDragOver={(e) => editMode && onDragOver(e, sectionKey)}
                onDragEnd={onDragEnd}
                className={`bg-white rounded-lg border border-[#e9e9e7] transition-all duration-200 ${isFlashing ? 'ring-2 ring-[#37352f]/20' : 'shadow-sm'} ${isWide ? 'col-span-2' : ''} ${editMode ? 'cursor-grab active:cursor-grabbing' : ''} ${isDragging ? 'opacity-50' : ''} ${isDragOver ? 'border-[#37352f]' : ''}`}
                >
                <div className="flex items-center justify-between px-3 py-1.5 bg-[#f7f7f5] border-b border-[#e9e9e7] rounded-t-lg">
                    <h2 className="text-[11px] font-semibold text-[#37352f]/50 uppercase tracking-wider">{section.name}</h2>
                    <div className="flex gap-0.5">
                    {editMode ? (
                        <React.Fragment>
                            <button onClick={() => onEdit(sectionKey)} className="p-1 text-[#37352f]/60 hover:bg-black/5 rounded"><Icons.Settings size={14}/></button>
                            <button onClick={() => onDelete(sectionKey)} className="p-1 text-red-600/60 hover:bg-red-50 rounded"><Icons.Trash2 size={14} /></button>
                        </React.Fragment>
                    ) : (
                        <React.Fragment>
                            <button onClick={() => onToggleLock(sectionKey)} className={`p-1 rounded transition-all ${section.locked ? 'text-[#c4914d]' : 'text-[#37352f]/40 hover:bg-black/5'}`}>
                                {section.locked ? <Icons.Lock size={14} /> : <Icons.Unlock size={14} />}
                            </button>
                            <button onClick={() => onToggleVisibility(sectionKey)} className="p-1 text-[#37352f]/40 hover:bg-black/5 rounded"><Icons.EyeOff size={14} /></button>
                        </React.Fragment>
                    )}
                    </div>
                </div>
                <div className={`text-center flex items-center justify-center ${isFullScreen ? 'py-12 min-h-[180px]' : 'py-8 min-h-[110px]'}`}>
                    <div className={`font-medium text-[#37352f] ${isFullScreen ? textSize.fullscreen : textSize.normal} px-4 leading-tight`}>{section.current}</div>
                </div>
                </div>
            );
        };

        const JazzPracticeApp = () => {
            const [sections, setSections] = useState(() => {
                const saved = localStorage.getItem('jazzPracticeSections');
                return saved ? JSON.parse(saved) : {
                    key: { name: 'Key', options: ['C', 'C#/Db', 'D', 'Eb', 'E', 'F', 'F#/Gb', 'G', 'G#/Ab', 'A', 'Bb', 'B'], visible: true, locked: false, current: 'C', row: 0, col: 0 },
                    chord: { name: 'Chord', options: ['maj7', 'm7', '7', 'm7b5', 'dim7', '7alt'], visible: true, locked: false, current: 'maj7', row: 0, col: 1 },
                    tune: { name: 'Tune', options: ['Autumn Leaves', 'Blue Bossa', 'Stella By Starlight', 'All The Things You Are'], visible: true, locked: false, current: 'Autumn Leaves', row: 1, col: 0, isWide: true }
                };
            });

            const [presets, setPresets] = useState(() => {
                const saved = localStorage.getItem('jazzPracticePresets');
                return saved ? JSON.parse(saved) : {};
            });

            const [themeColor, setThemeColor] = useState(() => localStorage.getItem('jazzPracticeTheme') || 'slate');
            const [isFullScreen, setIsFullScreen] = useState(() => localStorage.getItem('jazzPracticeFullScreen') === 'true');
            const [editMode, setEditMode] = useState(false);
            const [editingSection, setEditingSection] = useState(null);
            const [editForm, setEditForm] = useState({ name: '', options: '', isWide: false });
            const [showAddModal, setShowAddModal] = useState(false);
            const [showPresetManager, setShowPresetManager] = useState(false);
            const [presetName, setPresetName] = useState('');
            const [tempTheme, setTempTheme] = useState(themeColor);
            const [showHelpModal, setShowHelpModal] = useState(false);
            const [isFlashing, setIsFlashing] = useState(false);
            const [activePreset, setActivePreset] = useState(null);
            const [draggedSection, setDraggedSection] = useState(null);
            const [dragOverSection, setDragOverSection] = useState(null);
            const [deleteConfirmSection, setDeleteConfirmSection] = useState(null);

            useEffect(() => { localStorage.setItem('jazzPracticeSections', JSON.stringify(sections)); }, [sections]);
            useEffect(() => { localStorage.setItem('jazzPracticePresets', JSON.stringify(presets)); }, [presets]);
            useEffect(() => { localStorage.setItem('jazzPracticeTheme', themeColor); }, [themeColor]);
            useEffect(() => { localStorage.setItem('jazzPracticeFullScreen', isFullScreen); }, [isFullScreen]);

            const randomize = () => {
                setSections(prev => {
                    const next = {};
                    Object.keys(prev).forEach(k => {
                        next[k] = { ...prev[k] };
                        if (next[k].visible && !next[k].locked && next[k].options.length > 0) {
                            next[k].current = next[k].options[Math.floor(Math.random() * next[k].options.length)];
                        }
                    });
                    return next;
                });
                setIsFlashing(true);
                setTimeout(() => setIsFlashing(false), 200);
            };

            const toggleVisibility = (k) => setSections(p => ({ ...p, [k]: { ...p[k], visible: !p[k].visible } }));
            const toggleLock = (k) => setSections(p => ({ ...p, [k]: { ...p[k], locked: !p[k].locked } }));
            
            const handleSavePreset = () => {
                if (!presetName.trim()) return;
                const cfg = {};
                Object.entries(sections).forEach(([k, s]) => { cfg[k] = { visible: s.visible, locked: s.locked }; });
                setPresets(p => ({ ...p, [presetName]: { config: cfg, theme: tempTheme } }));
                setThemeColor(tempTheme);
                setActivePreset(presetName);
                setPresetName('');
                setShowPresetManager(false);
            };

            const loadPreset = (k) => {
                const p = presets[k];
                setSections(prev => {
                    const next = { ...prev };
                    Object.entries(p.config).forEach(([sk, cfg]) => {
                        if (next[sk]) next[sk] = { ...next[sk], ...cfg };
                    });
                    return next;
                });
                setThemeColor(p.theme);
                setActivePreset(k);
            };

            const deletePreset = (k) => {
                setPresets(prev => {
                    const next = { ...prev };
                    delete next[k];
                    return next;
                });
                if (activePreset === k) setActivePreset(null);
            };

            const currentTheme = THEME_COLORS[themeColor];

            return (
                <div className={`min-h-screen ${currentTheme.bg} transition-colors duration-500 pb-20`}>
                    <div className="max-w-2xl mx-auto px-4 pt-8">
                        {!isFullScreen && (
                            <div className="mb-10">
                                <h1 className="text-[#37352f] text-3xl font-bold tracking-tight mb-2">Jazz Practice</h1>
                                <div className="flex gap-2 overflow-x-auto pb-4 no-scrollbar">
                                    {Object.keys(presets).map(k => (
                                        <button 
                                            key={k} 
                                            onClick={() => loadPreset(k)}
                                            className={`px-3 py-1 rounded-md text-sm font-medium transition-all whitespace-nowrap ${activePreset === k ? 'bg-[#37352f] text-white' : 'bg-white border border-[#e9e9e7] text-[#37352f] hover:bg-[#f7f7f5]'}`}
                                        >
                                            {k}
                                        </button>
                                    ))}
                                </div>

                                <div className="bg-white border border-[#e9e9e7] rounded-lg p-1 flex justify-between items-center shadow-sm">
                                    <div className="flex">
                                        <button onClick={() => setEditMode(!editMode)} className={`flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium transition-all ${editMode ? 'bg-[#37352f] text-white' : 'text-[#37352f]/70 hover:bg-[#f7f7f5]'}`}>
                                            <Icons.Settings size={16}/> {editMode ? 'Done' : 'Edit'}
                                        </button>
                                        <button onClick={() => setShowPresetManager(true)} className="flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium text-[#37352f]/70 hover:bg-[#f7f7f5] transition-all">
                                            <Icons.Bookmark size={16}/> Save
                                        </button>
                                        {editMode && (
                                            <button onClick={() => setShowAddModal(true)} className="flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium text-[#37352f]/70 hover:bg-[#f7f7f5]">
                                                <Icons.Plus size={16}/> Add
                                            </button>
                                        )}
                                    </div>
                                    <button onClick={() => setIsFullScreen(true)} className="p-1.5 text-[#37352f]/40 hover:bg-[#f7f7f5] rounded-md">
                                        <Icons.Maximize size={18}/>
                                    </button>
                                </div>
                            </div>
                        )}

                        {isFullScreen && (
                            <div className="flex justify-between items-center mb-8">
                                <span className="text-[11px] font-bold text-[#37352f]/30 uppercase tracking-widest">Focused Practice</span>
                                <button onClick={() => setIsFullScreen(false)} className="text-[#37352f]/50 hover:text-[#37352f] flex items-center gap-1 text-sm">
                                    <Icons.Minimize size={16}/> Exit
                                </button>
                            </div>
                        )}

                        <div className="grid grid-cols-2 gap-4 mb-8">
                            {Object.entries(sections).filter(([_, s]) => s.visible || editMode).sort((a,b) => a[1].row - b[1].row).map(([k, s]) => (
                                <PracticeSection 
                                    key={k} sectionKey={k} section={s} isFullScreen={isFullScreen} editMode={editMode}
                                    onToggleVisibility={toggleVisibility} onToggleLock={toggleLock}
                                    textSize={TEXT_SIZES.small} isFlashing={isFlashing} isWide={s.isWide}
                                    onEdit={(key) => { setEditingSection(key); setEditForm({ name: s.name, options: s.options.join(', '), isWide: s.isWide }); }}
                                    onDelete={(key) => setDeleteConfirmSection(key)}
                                />
                            ))}
                        </div>

                        <div className="fixed bottom-8 left-0 right-0 px-4">
                            <div className="max-w-2xl mx-auto">
                                <button onClick={randomize} className={`w-full py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all active:scale-[0.98] ${currentTheme.primary} ${currentTheme.text} ${currentTheme.hover}`}>
                                    <Icons.Shuffle size={20}/>
                                    <span className="font-bold tracking-wide">RANDOMIZE</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* MODAL: PRESET & THEME (Consolidated) */}
                    {showPresetManager && (
                        <div className="fixed inset-0 bg-white/80 backdrop-blur-md flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl p-8 max-w-sm w-full border border-[#e9e9e7] shadow-2xl">
                                <h3 className="text-xl font-bold text-[#37352f] mb-6">Preset Settings</h3>
                                
                                <label className="block text-xs font-bold text-[#37352f]/40 uppercase tracking-widest mb-2">Preset Name</label>
                                <input 
                                    type="text" value={presetName} onChange={e => setPresetName(e.target.value)}
                                    placeholder="Daily Routine..."
                                    className="w-full bg-[#f7f7f5] border border-[#e9e9e7] p-3 rounded-lg mb-6 focus:outline-none focus:border-[#37352f]/20"
                                />

                                <label className="block text-xs font-bold text-[#37352f]/40 uppercase tracking-widest mb-3">Theme Color</label>
                                <div className="grid grid-cols-4 gap-3 mb-8">
                                    {Object.entries(THEME_COLORS).map(([k, color]) => (
                                        <button 
                                            key={k} onClick={() => setTempTheme(k)}
                                            className={`h-10 w-full rounded-md transition-all ${color.primary} ${tempTheme === k ? 'ring-offset-2 ring-2 ring-[#37352f]' : 'opacity-80 hover:opacity-100'}`}
                                            title={color.name}
                                        />
                                    ))}
                                </div>

                                <div className="space-y-3 mb-8 max-h-40 overflow-y-auto pr-2">
                                    {Object.keys(presets).map(k => (
                                        <div key={k} className="flex items-center justify-between group">
                                            <span className="text-sm font-medium text-[#37352f]">{k}</span>
                                            <button onClick={() => deletePreset(k)} className="text-red-400 opacity-0 group-hover:opacity-100 p-1"><Icons.Trash2 size={14}/></button>
                                        </div>
                                    ))}
                                </div>

                                <div className="flex gap-3">
                                    <button onClick={handleSavePreset} className="flex-1 bg-[#37352f] text-white py-3 rounded-xl font-bold hover:bg-[#201f1c]">Save</button>
                                    <button onClick={() => setShowPresetManager(false)} className="flex-1 bg-[#f7f7f5] text-[#37352f] py-3 rounded-xl font-bold">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Simple Edit Section Modal */}
                    {editingSection && (
                        <div className="fixed inset-0 bg-white/80 backdrop-blur-md flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl p-8 max-w-md w-full border border-[#e9e9e7] shadow-2xl">
                                <h3 className="text-xl font-bold mb-6">Edit Section</h3>
                                <input className="w-full bg-[#f7f7f5] border border-[#e9e9e7] p-3 rounded-lg mb-4" value={editForm.name} onChange={e => setEditForm({...editForm, name: e.target.value})} />
                                <textarea className="w-full bg-[#f7f7f5] border border-[#e9e9e7] p-3 rounded-lg mb-4 h-32" value={editForm.options} onChange={e => setEditForm({...editForm, options: e.target.value})} />
                                <div className="flex gap-3">
                                    <button onClick={() => {
                                        const opts = editForm.options.split(',').map(o => o.trim()).filter(o => o.length);
                                        setSections(p => ({...p, [editingSection]: {...p[editingSection], name: editForm.name, options: opts, current: opts[0]}}));
                                        setEditingSection(null);
                                    }} className="flex-1 bg-[#37352f] text-white py-3 rounded-xl font-bold">Save</button>
                                    <button onClick={() => setEditingSection(null)} className="flex-1 bg-[#f7f7f5] text-[#37352f] py-3 rounded-xl font-bold">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<JazzPracticeApp />);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed', err));
            });
        }
    </script>
</body>
</html>